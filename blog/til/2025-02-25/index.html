<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/julie/_next/static/media/a15f2fce4b98b461-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https://julielee9067.github.io/julie?&amp;count_bg=%23B397D3&amp;title_bg=%23DDBCD8&amp;icon=awesomelists.svg&amp;icon_color=%23E7E7E7&amp;title=-++&amp;edge_flat=false"/><link rel="stylesheet" href="/julie/_next/static/css/064e10fa6619f508.css" data-precedence="next"/><link rel="stylesheet" href="/julie/_next/static/css/e680cef9016abb97.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/julie/_next/static/chunks/webpack-f21d1ea040903a64.js"/><script src="/julie/_next/static/chunks/fd9d1056-31cd4e5e32ed9a2a.js" async=""></script><script src="/julie/_next/static/chunks/117-716e42ebd9d4aa99.js" async=""></script><script src="/julie/_next/static/chunks/main-app-6f6fdd4063037f11.js" async=""></script><script src="/julie/_next/static/chunks/137-7c01c277e0f0cc48.js" async=""></script><script src="/julie/_next/static/chunks/269-a28aad18182cd41e.js" async=""></script><script src="/julie/_next/static/chunks/614-0bac26ad143a75db.js" async=""></script><script src="/julie/_next/static/chunks/app/blog/%5B...slug%5D/page-c538284416fbde4d.js" async=""></script><script src="/julie/_next/static/chunks/648-3ae006cfe07c9d94.js" async=""></script><script src="/julie/_next/static/chunks/app/blog/layout-a0ac16c7cad7b2d1.js" async=""></script><script src="/julie/_next/static/chunks/app/layout-2f9a78561536bd6f.js" async=""></script><title>Julie Lee&#x27;s Portfolio</title><meta name="description" content="Welcome to Julie&#x27;s portfolio page."/><meta name="next-size-adjust"/><script src="/julie/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_29e2ff"><script>((e,t,r,n,o,a,l,i)=>{let u=document.documentElement,s=["light","dark"];function c(t){(Array.isArray(e)?e:[e]).forEach(e=>{let r="class"===e,n=r&&a?o.map(e=>a[e]||e):o;r?(u.classList.remove(...n),u.classList.add(t)):u.setAttribute(e,t)}),i&&s.includes(t)&&(u.style.colorScheme=t)}if(n)c(n);else try{let e=localStorage.getItem(t)||r,n=l&&"system"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;c(n)}catch(e){}})("class","theme","system",null,["light","dark"],null,true,true)</script><header class="fixed top-0 left-0 w-full z-50 bg-background/80 backdrop-blur-sm border-b"><div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between"><a class="font-bold text-lg" href="/julie/">JULIE</a><div class="flex items-center gap-4"><a><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https://julielee9067.github.io/julie?&amp;count_bg=%23B397D3&amp;title_bg=%23DDBCD8&amp;icon=awesomelists.svg&amp;icon_color=%23E7E7E7&amp;title=-++&amp;edge_flat=false"/></a><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download w-4 h-4 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>이력서</button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-3 w-16">KO</button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-[1.2rem] w-[1.2rem] transition-all dark:hidden"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon h-[1.2rem] w-[1.2rem] hidden transition-all dark:block"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button></div></div></header><div class="min-h-screen flex flex-col bg-white dark:bg-black"><div class="pt-16 flex flex-1"><aside class="
        fixed top-16 left-0 h-[calc(100vh-4rem)] w-64
        bg-white dark:bg-neutral-900 text-black dark:text-white
        border-r border-gray-200 dark:border-gray-700 shadow-sm p-6 overflow-y-auto z-50
        transition-transform duration-300
        translate-x-0
        lg:translate-x-0
      "><h2 class="text-lg font-semibold mb-4">카테고리</h2><ul class="space-y-2"><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/">전체</a></li><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/to-do/">TO DO 리스트</a></li><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/algorithms/">알고리즘</a></li><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/til/">Today I Learned</a></li><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/cs/">컴퓨터 공학</a></li><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/computer-networks/">컴퓨터 네트워크</a></li><li><a class="block px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition" href="/julie/blog/system-design/">시스템 디자인</a></li></ul></aside><main class="flex-1 p-6 transition-all duration-300 ml-0 lg:ml-64"><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--></main></div><button class="
            fixed left-0 top-1/2 -translate-y-1/2 z-50 p-2 rounded-r-md shadow transition
            bg-white text-black hover:bg-gray-100
            dark:dark:bg-neutral-900 dark:text-white dark:hover:bg-neutral-800
          ">&lt;</button><div class="fixed inset-0 bg-black/30 z-40 lg:hidden"></div></div><script src="/julie/_next/static/chunks/webpack-f21d1ea040903a64.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/julie/_next/static/media/a15f2fce4b98b461-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/julie/_next/static/css/064e10fa6619f508.css\",\"style\"]\n3:HL[\"/julie/_next/static/css/e680cef9016abb97.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"4:I[2846,[],\"\"]\n6:\"$Sreact.suspense\"\n7:I[1523,[\"137\",\"static/chunks/137-7c01c277e0f0cc48.js\",\"269\",\"static/chunks/269-a28aad18182cd41e.js\",\"614\",\"static/chunks/614-0bac26ad143a75db.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-c538284416fbde4d.js\"],\"BailoutToCSR\"]\n8:I[3124,[\"137\",\"static/chunks/137-7c01c277e0f0cc48.js\",\"269\",\"static/chunks/269-a28aad18182cd41e.js\",\"614\",\"static/chunks/614-0bac26ad143a75db.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-c538284416fbde4d.js\"],\"default\"]\na:I[4707,[],\"\"]\nc:I[6423,[],\"\"]\nd:I[3483,[\"648\",\"static/chunks/648-3ae006cfe07c9d94.js\",\"768\",\"static/chunks/app/blog/layout-a0ac16c7cad7b2d1.js\"],\"default\",1]\ne:I[5495,[\"137\",\"static/chunks/137-7c01c277e0f0cc48.js\",\"648\",\"static/chunks/648-3ae006cfe07c9d94.js\",\"185\",\"static/chunks/app/layout-2f9a78561536bd6f.js\"],\"ThemeProvider\"]\nf:I[4491,[\"137\",\"static/chunks/137-7c01c277e0f0cc48.js\",\"648\",\"static/chunks/648-3ae006cfe07c9d94.js\",\"185\",\"static/chunks/app/layout-2f9a78561536bd6f.js\"],\"LanguageProvider\"]\n10:I[1890,[\"137\",\"static/chunks/137-7c01c277e0f0cc48.js\",\"648\",\"static/chunks/648-3ae006cfe07c9d94.js\",\"185\",\"static/chunks/app/layout-2f9a78561536bd6f.js\"],\"Header\"]\n12:I[1060,[],\"\"]\n9:Tdd6,"])</script><script>self.__next_f.push([1,"\nMongo Atlas Search에서 full-text search를 사용할 때 여러 search node로 쿼리를 분산시킬 수 있다.\n그런데 쿼리를 실행할 때마다 **어느 search node를 사용하냐에 따라 결과가 달라진다**는 사실을 발견했다.\n\n특히 search score가 낮은 document들만 꾸준히 드랍되는 것을 목격할 수 있었다.\n구체적으로, query를 돌릴 때 각 search node가 몇 개의 문서를 훑어보고 결과를 도출하는지 확인할 수 있는데, 그 숫자가 검색할 때마다 달라지는 현상이 있었다. (따라서 검색 결과도 달라졌다.)\n\n\nMongo support 팀에 문의한 결과 이런 경우가 가끔 발생한다고 응답이 왔고, 아직 정확한 원인을 파악하지 못했다고 한다.\n\n대신, search node(`mongot`)를 전용 노드에서 따로 실행하는 대신 **데이터베이스 자체(`mongod`)와 같은 노드에서 실행**하면 일관성있는 결과를 얻을 수 있을 것이라는 답변을 받았다.\n\n하지만 서포트 팀에서 얘기한 솔루션은 [공식 문서](https://www.mongodb.com/docs/atlas/atlas-search/about/deployment-options/#fts-deployment-options)에 따르면 Testing/Prototyping 환경에 적합한 것으로, 이 사용 사례는 우리가 처한 상황과는 맞지 않다. \n우리가 인덱스 해야하는 총 문서는 2억 건 이상이고, 데이터 양도 당연히 10GB는 훨씬 넘기 때문이다.\n\n그리고 `mongot`와 `mongod`가 같은 노드에서 실행되면 두 프로세스 간 리소스 contention이 발생할 수 있어 이상적인 환경은 아닌 것 같다.\n\nElasticsearch처럼 `mongot`도 Apache Lucene을 기반으로 만들어져있는데, [공식 문서](https://www.mongodb.com/docs/atlas/atlas-search/atlas-search-overview/#fts-architecture)에 따르면 세 가지 일을 담당한다.\n\n1. Atlas search 인덱스 생성\n2. 문서 상태 및 인덱스 변경 사항 모니터링\n3. 검색 쿼리 처리: 여기서 문서 ID와 검색 점수를 산출하고, 이 내용을 바탕으로 `mongod`에서 최종 결과를 가져온다\n\n처음엔 2번 과정에서 동기화 문제가 있어서 그런건가 싶었는데, 데이터베이스에 아무 변화가 없고 인덱스 rebuilding도 모두 완료된 상태에서도 검색 결과가 계속 달라지는 현상이 나타났다.\n(eventual consistency와는 관련이 없는 상황)\n\n그래서 지금 생각으로는 뭔가 인덱스에 있는 fuzzy search 때문에 Mongo 백그라운드에서 특정 document들을 제거 하는게 아닌가 싶긴 하지만, Mongo search 팀에서 일하는 사람이 원인을 모른다고 하니까 조금 답답하다.\n(하지만 우리보다 훨씬 복잡한 인덱스를 쓰는 사람들도 별 문제가 없는 사람들도 많았다고 하니 확실하진 않다.)\n\n우선 Mongo support에서 제시한 솔루션대로 내일 진행해보고, 쿼리 성능이나 결과를 좀 더 면밀히 분석한 후 추가로 글을 업데이트할 예정이다.\n\n---\n2025-02-28\n\n업데이트: Resource contention 문제로 인해 단일 search node를 분리해서 사용하는 방안을 고민했으나, search query가 많을 경우 노드 하나로는 부하가 과도할 것으로 판단하였다. \n따라서 replica와 main DB에 **colocated search node**를 함께 구성하는 것이 최선이라는 결론을 내렸다.\n\n`preference=secondary` 설정을 적용하여 replica가 모두 사용 불가능한 상황이 아닐 경우, 우선적으로 replica를 활용하도록 설정하였다.\n"])</script><script>self.__next_f.push([1,"b:[\"slug\",\"til/2025-02-25\",\"c\"]\n13:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L4\",null,{\"buildId\":\"V4za5p5BBtSVX8JZ1nOKZ\",\"assetPrefix\":\"/julie\",\"urlParts\":[\"\",\"blog\",\"til\",\"2025-02-25\",\"\"],\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"til/2025-02-25\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"til\\\",\\\"2025-02-25\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"til/2025-02-25\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L5\",[\"$\",\"$6\",null,{\"fallback\":null,\"children\":[\"$\",\"$L7\",null,{\"reason\":\"next/dynamic\",\"children\":[\"$\",\"$L8\",null,{\"post\":{\"slug\":\"til/2025-02-25\",\"categorySlug\":\"til\",\"title\":{\"ko\":\"2025-02-25\",\"en\":\"2025-02-25\"},\"date\":\"2025-02-25 16:57\",\"category\":{\"ko\":\"TIL\",\"en\":\"TIL\"},\"description\":{\"ko\":\"Mongo Atlas full-text search에서 search node가 여러 개일 때 발생하는 문제\",\"en\":\"Issues with multiple search nodes in Mongo Atlas full-text search\"},\"content\":\"$9\"}}]}]}],null],null],null]},[null,[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$b\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[null,[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}],\"params\":{}}]],null],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/julie/_next/static/css/064e10fa6619f508.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/julie/_next/static/css/e680cef9016abb97.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"ko\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_29e2ff\",\"children\":[\"$\",\"$Le\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lf\",null,{\"children\":[[\"$\",\"$L10\",null,{}],[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]]}]}]}]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$L11\"],\"globalErrorComponent\":\"$12\",\"missingSlots\":\"$W13\"}]\n"])</script><script>self.__next_f.push([1,"11:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Julie Lee's Portfolio\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Welcome to Julie's portfolio page.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n5:null\n"])</script></body></html>